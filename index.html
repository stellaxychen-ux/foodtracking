<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>P-Care | èƒ°è…ºè¥å…»åŠ©æ‰‹</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

  <style>
    :root{
      --bg: #F5F7FB;
      --card: #FFFFFF;
      --text: #0F172A;
      --muted: #64748B;
      --border: rgba(15,23,42,.08);

      --safe: #16A34A;
      --caution: #F59E0B;
      --avoid: #EF4444;

      --brand1:#2563EB;
      --brand2:#7C3AED;
    }
    html,body{ background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    .card{ background: var(--card); border: 1px solid var(--border); border-radius: 18px; box-shadow: 0 10px 25px rgba(15,23,42,.06); }
    .chip{ border: 1px solid var(--border); border-radius: 999px; padding:.25rem .6rem; font-size:.75rem; color: var(--muted); background: rgba(255,255,255,.7); }
    .badge{ border-radius: 999px; padding: .2rem .55rem; font-size:.75rem; font-weight: 700; }
    .badge-safe{ background: rgba(22,163,74,.12); color: var(--safe); }
    .badge-caution{ background: rgba(245,158,11,.14); color: var(--caution); }
    .badge-avoid{ background: rgba(239,68,68,.12); color: var(--avoid); }
    .btn-primary{
      background: linear-gradient(135deg, var(--brand1) 0%, var(--brand2) 100%);
      color: white;
    }
    .btn-ghost{
      background: rgba(255,255,255,.85);
      border: 1px solid var(--border);
      color: #0F172A;
    }
    .food-left-safe{ border-left: 6px solid var(--safe); }
    .food-left-caution{ border-left: 6px solid var(--caution); }
    .food-left-avoid{ border-left: 6px solid var(--avoid); }

    /* Toast */
    .toast{ position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); z-index: 60; }
    .toast > div{ background: rgba(15,23,42,.92); color: white; border-radius: 14px; padding: 10px 14px; box-shadow: 0 12px 30px rgba(0,0,0,.18); font-size: 14px; display:flex; align-items:center; gap:10px; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; padding: 1px 6px; border-radius: 6px; background: rgba(15,23,42,.06); border:1px solid var(--border); font-size: 12px; }
  </style>
</head>

<body class="pb-24">

  <!-- Top bar -->
  <header class="sticky top-0 z-50 backdrop-blur bg-white/70 border-b" style="border-color: var(--border);">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl flex items-center justify-center text-white"
             style="background: linear-gradient(135deg, var(--brand1), var(--brand2));">
          <i class="fa-solid fa-staff-snake"></i>
        </div>
        <div>
          <div class="flex items-center gap-2">
            <h1 class="text-lg sm:text-xl font-extrabold tracking-tight">P-Care</h1>
            <span class="chip">èƒ°è…ºè¥å…»åŠ©æ‰‹</span>
          </div>
          <p class="text-xs text-slate-500 mt-0.5">
            å°‘é‡å¤šé¤ï½œé«˜è›‹ç™½ï½œä½è„‚ä½çº¤ç»´ï½œå› äººè€Œå¼‚ï¼ˆè¯·ä»¥åŒ»ç”Ÿ/è¥å…»å¸ˆæŒ‡å¯¼ä¸ºå‡†ï¼‰
          </p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnLang" class="btn-ghost px-3 py-2 rounded-xl text-sm font-semibold">
          <i class="fa-solid fa-language mr-2"></i><span id="langLabel">ä¸­æ–‡</span>
        </button>
        <button onclick="openSettings()" class="btn-ghost px-3 py-2 rounded-xl text-sm font-semibold">
          <i class="fa-solid fa-gear mr-2"></i>è®¾ç½®
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 pt-6 space-y-6">

    <!-- Dashboard -->
    <section class="card p-5 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
        <div>
          <h2 class="text-base sm:text-lg font-extrabold">
            <span data-i18n="dailyGoalsTitle">æ¯æ—¥ç›®æ ‡</span>
            <span class="text-xs font-normal text-slate-500 ml-2">
              (<span data-i18n="targetWeight">ç›®æ ‡ä½“é‡</span>ï¼š<span id="targetWeightDisplay">--</span> kg)
            </span>
          </h2>
          <p class="text-sm text-slate-500 mt-1" id="goalHint">
            å»ºè®®èŒƒå›´å¯åœ¨è®¾ç½®ä¸­è°ƒæ•´ï¼ˆèƒ½é‡/è›‹ç™½æŒ‰ä½“é‡ä¼°ç®—ï¼‰ã€‚
          </p>
        </div>

        <div class="flex items-center gap-2">
          <span class="chip"><i class="fa-solid fa-utensils mr-2"></i><span id="mealModeLabel">æœ¯å/æ¶ˆåŒ–æ•æ„Ÿ</span></span>
          <span class="chip"><i class="fa-solid fa-shield-heart mr-2"></i><span data-i18n="guideLabel">é£Ÿç‰©å®‰å…¨åˆ†çº§</span></span>
        </div>
      </div>

      <!-- Calories -->
      <div class="mt-5">
        <div class="flex justify-between text-sm">
          <span class="text-slate-600 font-semibold">
            <i class="fa-solid fa-fire mr-2 text-orange-500"></i><span data-i18n="calories">çƒ­é‡</span>
          </span>
          <span class="font-extrabold text-slate-800">
            <span id="calCurrent">0</span> / <span id="calTarget">2000</span> kcal
          </span>
        </div>
        <div class="w-full bg-slate-200/70 rounded-full h-3 mt-2 overflow-hidden">
          <div id="calBar" class="h-3 rounded-full" style="width:0%; background: linear-gradient(90deg,#F97316,#FB7185);"></div>
        </div>
      </div>

      <!-- Protein -->
      <div class="mt-4">
        <div class="flex justify-between text-sm">
          <span class="text-slate-600 font-semibold">
            <i class="fa-solid fa-drumstick-bite mr-2 text-blue-600"></i><span data-i18n="protein">è›‹ç™½è´¨</span>
          </span>
          <span class="font-extrabold text-slate-800">
            <span id="protCurrent">0</span> / <span id="protTarget">80</span> g
          </span>
        </div>
        <div class="w-full bg-slate-200/70 rounded-full h-3 mt-2 overflow-hidden">
          <div id="protBar" class="h-3 rounded-full" style="width:0%; background: linear-gradient(90deg,#2563EB,#22C55E);"></div>
        </div>
        <p class="text-xs text-slate-500 mt-2">
          <i class="fa-solid fa-circle-info mr-1"></i>
          <span data-i18n="proteinTip">æœ¯å/æ²»ç–—æœŸé—´å¸¸å¼ºè°ƒé«˜è›‹ç™½ä»¥å¸®åŠ©æ¢å¤ï¼›å…·ä½“ä»¥ä¸ªä½“è€å—ä¸åŒ»å˜±ä¸ºå‡†ã€‚</span>
        </p>
      </div>

      <div class="mt-5 flex flex-col sm:flex-row gap-3">
        <button onclick="askAI()" class="btn-primary px-4 py-3 rounded-2xl font-extrabold flex items-center justify-center gap-2">
          <i class="fa-solid fa-robot"></i><span data-i18n="askAI">é—® AI åŠ©æ‰‹</span>
        </button>
        <button onclick="googleSearch()" class="btn-ghost px-4 py-3 rounded-2xl font-extrabold flex items-center justify-center gap-2">
          <i class="fa-brands fa-google"></i><span data-i18n="searchWeb">ç½‘é¡µæ£€ç´¢</span>
        </button>
        <button onclick="resetToday()" class="btn-ghost px-4 py-3 rounded-2xl font-extrabold flex items-center justify-center gap-2">
          <i class="fa-solid fa-rotate-left"></i><span data-i18n="reset">æ¸…ç©ºä»Šæ—¥</span>
        </button>
      </div>
    </section>

    <!-- Search + Filters -->
    <section class="card p-5 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h3 class="text-lg font-extrabold">
            <span data-i18n="foodGuideTitle">é£Ÿç‰©å®‰å…¨æŒ‡å—</span>
          </h3>
          <p class="text-sm text-slate-500 mt-1">
            <span data-i18n="searchHint">è¾“å…¥ä¸­æ–‡æˆ–è‹±æ–‡ï¼šä¾‹å¦‚â€œé¸¡è›‹ç¾¹ / å°ç±³ç²¥ / banana / steakâ€ã€‚æ”¯æŒåˆ«ååŒ¹é…ã€‚</span>
          </p>
        </div>

        <div class="flex gap-2 flex-wrap">
          <button class="btn-ghost px-3 py-2 rounded-xl text-sm font-bold" onclick="setFilter('all')" id="fltAll">
            <i class="fa-solid fa-layer-group mr-2"></i><span data-i18n="all">å…¨éƒ¨</span>
          </button>
          <button class="btn-ghost px-3 py-2 rounded-xl text-sm font-bold" onclick="setFilter('safe')" id="fltSafe">
            <i class="fa-solid fa-circle-check mr-2 text-green-600"></i><span data-i18n="safe">æ¨è</span>
          </button>
          <button class="btn-ghost px-3 py-2 rounded-xl text-sm font-bold" onclick="setFilter('caution')" id="fltCaution">
            <i class="fa-solid fa-triangle-exclamation mr-2 text-amber-600"></i><span data-i18n="caution">è°¨æ…</span>
          </button>
          <button class="btn-ghost px-3 py-2 rounded-xl text-sm font-bold" onclick="setFilter('avoid')" id="fltAvoid">
            <i class="fa-solid fa-circle-xmark mr-2 text-red-600"></i><span data-i18n="avoid">é¿å…</span>
          </button>
        </div>
      </div>

      <div class="mt-4 relative">
        <input id="foodSearch" oninput="refresh()" placeholder="æˆ‘èƒ½åƒâ€¦ï¼ˆå¦‚ï¼šå°ç±³ç²¥ / è’¸é±¼ / yogurtï¼‰"
               class="w-full p-4 rounded-2xl outline-none bg-white border"
               style="border-color: var(--border);"
        />
        <div class="absolute right-4 top-4 text-slate-400">
          <i class="fa-solid fa-magnifying-glass"></i>
        </div>
        <p class="text-xs text-slate-500 mt-2">
          <span class="kbd">Enter</span> = é€‰æ‹©ç¬¬ 1 ä¸ªåŒ¹é…é¡¹å¹¶åŠ å…¥è®°å½•ï¼ˆè‹¥ä¸ºâ€œé¿å…â€å°†ä¸ä¼šåŠ å…¥ï¼‰
        </p>
      </div>

      <div class="mt-5 space-y-3" id="foodList"></div>

      <div id="notFound" class="hidden mt-6 text-center p-6 rounded-2xl border bg-white"
           style="border-color: var(--border);">
        <p class="text-slate-600 font-semibold" data-i18n="notFoundTitle">æœªåœ¨æœ¬åœ°ä¸´åºŠé£Ÿç‰©åº“ä¸­æ‰¾åˆ°ã€‚</p>
        <p class="text-sm text-slate-500 mt-1" data-i18n="notFoundDesc">
          ä½ å¯ä»¥ç‚¹å‡»â€œé—® AI åŠ©æ‰‹â€ï¼ŒæŠŠä½ çš„å…·ä½“æƒ…å†µï¼ˆæœ¯åå‘¨æ•°ã€ç—‡çŠ¶ã€æ˜¯å¦è…¹æ³»/è„‚è‚ªæ³»ã€æ˜¯å¦åœ¨ç”¨èƒ°é…¶ï¼‰ä¸€èµ·æè¿°ï¼Œä¼šæ›´å‡†ç¡®ã€‚
        </p>
        <button onclick="askAI()" class="mt-4 btn-primary px-4 py-3 rounded-2xl font-extrabold inline-flex items-center gap-2">
          <i class="fa-solid fa-robot"></i><span data-i18n="askAI">é—® AI åŠ©æ‰‹</span>
        </button>
      </div>
    </section>

    <!-- Disclaimer -->
    <section class="text-xs text-slate-500 px-1">
      <p>
        <i class="fa-solid fa-circle-info mr-1"></i>
        <span data-i18n="disclaimer">
          å…è´£å£°æ˜ï¼šæœ¬å·¥å…·ç”¨äºå¥åº·æ•™è‚²ä¸è‡ªæˆ‘è®°å½•ï¼Œä¸èƒ½æ›¿ä»£åŒ»ç”Ÿ/è¥å…»å¸ˆè¯Šç–—ã€‚è‹¥å‡ºç°æŒç»­å‘•åã€æ— æ³•è¿›é£Ÿã€æ˜æ˜¾è…¹ç—›ã€é»‘ä¾¿/ä¾¿è¡€ã€å¿«é€Ÿä½“é‡ä¸‹é™ç­‰ï¼Œè¯·åŠæ—¶å°±åŒ»ã€‚
        </span>
      </p>
    </section>

  </main>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50 p-4">
    <div class="card w-full max-w-xl p-5 sm:p-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-lg font-extrabold" data-i18n="settingsTitle">ä¸ªæ€§åŒ–è®¾ç½®</h3>
          <p class="text-sm text-slate-500 mt-1" data-i18n="settingsDesc">
            ç›®æ ‡æŒ‰ä½“é‡ä¼°ç®—ï¼›ä½ å¯åœ¨å»ºè®®åŒºé—´å†…è°ƒæ•´çƒ­é‡/è›‹ç™½ç³»æ•°ï¼Œå¹¶ä¿å­˜åˆ°æœ¬æœºï¼ˆlocalStorageï¼‰ã€‚
          </p>
        </div>
        <button onclick="closeSettings()" class="btn-ghost px-3 py-2 rounded-xl font-bold">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-bold text-slate-700" data-i18n="weightLabel">ä½“é‡ (kg)</label>
          <input type="number" id="weightInput" class="mt-2 w-full p-3 rounded-xl border outline-none"
                 style="border-color: var(--border);" min="20" max="200" />
          <p class="text-xs text-slate-500 mt-2" data-i18n="weightTip">ç”¨äºä¼°ç®—æ¯æ—¥èƒ½é‡ä¸è›‹ç™½ç›®æ ‡ã€‚</p>
        </div>

        <div>
          <label class="text-sm font-bold text-slate-700" data-i18n="modeLabel">æ¨¡å¼</label>
          <select id="modeInput" class="mt-2 w-full p-3 rounded-xl border outline-none"
                  style="border-color: var(--border);">
            <option value="sensitive">æœ¯å/æ¶ˆåŒ–æ•æ„Ÿï¼ˆæ›´ä¸¥æ ¼ï¼‰</option>
            <option value="stable">ç›¸å¯¹ç¨³å®šï¼ˆé€æ­¥æ¢å¤ï¼‰</option>
          </select>
          <p class="text-xs text-slate-500 mt-2" data-i18n="modeTip">æ¨¡å¼ä¼šå½±å“â€œé¿å…/è°¨æ…â€çš„æç¤ºæ–‡æ¡ˆï¼ˆä¸æ›¿ä»£ä¸ªä½“åŒ–åŒ»å˜±ï¼‰ã€‚</p>
        </div>

        <div class="sm:col-span-2">
          <label class="text-sm font-bold text-slate-700" data-i18n="calFactor">çƒ­é‡ç³»æ•° (kcal/kgÂ·d)</label>
          <input type="range" id="calPerKgInput" min="25" max="35" step="1" class="mt-2 w-full" />
          <div class="flex justify-between text-xs text-slate-500">
            <span>25</span>
            <span><span data-i18n="current">å½“å‰</span>ï¼š<b id="calPerKgLabel">30</b></span>
            <span>35</span>
          </div>
        </div>

        <div class="sm:col-span-2">
          <label class="text-sm font-bold text-slate-700" data-i18n="protFactor">è›‹ç™½ç³»æ•° (g/kgÂ·d)</label>
          <input type="range" id="protPerKgInput" min="1.2" max="2.0" step="0.1" class="mt-2 w-full" />
          <div class="flex justify-between text-xs text-slate-500">
            <span>1.2</span>
            <span><span data-i18n="current">å½“å‰</span>ï¼š<b id="protPerKgLabel">1.5</b></span>
            <span>2.0</span>
          </div>
        </div>
      </div>

      <div class="mt-6 flex flex-col sm:flex-row gap-3">
        <button onclick="saveSettings()" class="btn-primary px-4 py-3 rounded-2xl font-extrabold flex-1">
          <i class="fa-solid fa-floppy-disk mr-2"></i><span data-i18n="save">ä¿å­˜å¹¶é‡æ–°è®¡ç®—</span>
        </button>
        <button onclick="restoreDefaults()" class="btn-ghost px-4 py-3 rounded-2xl font-extrabold flex-1">
          <i class="fa-solid fa-wand-magic-sparkles mr-2"></i><span data-i18n="defaults">æ¢å¤é»˜è®¤</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast hidden" id="toast">
    <div>
      <i class="fa-solid fa-circle-check text-green-400"></i>
      <span id="toastMsg">å·²åŠ å…¥è®°å½•</span>
    </div>
  </div>

<script>
/** =========================
 *  0) i18n (ä¸­è‹±åˆ‡æ¢)
 *  ========================= */
const i18n = {
  zh: {
    dailyGoalsTitle:"æ¯æ—¥ç›®æ ‡",
    targetWeight:"ç›®æ ‡ä½“é‡",
    guideLabel:"é£Ÿç‰©å®‰å…¨åˆ†çº§",
    calories:"çƒ­é‡",
    protein:"è›‹ç™½è´¨",
    proteinTip:"æœ¯å/æ²»ç–—æœŸé—´å¸¸å¼ºè°ƒé«˜è›‹ç™½ä»¥å¸®åŠ©æ¢å¤ï¼›å…·ä½“ä»¥ä¸ªä½“è€å—ä¸åŒ»å˜±ä¸ºå‡†ã€‚",
    askAI:"é—® AI åŠ©æ‰‹",
    searchWeb:"ç½‘é¡µæ£€ç´¢",
    reset:"æ¸…ç©ºä»Šæ—¥",
    foodGuideTitle:"é£Ÿç‰©å®‰å…¨æŒ‡å—",
    searchHint:"è¾“å…¥ä¸­æ–‡æˆ–è‹±æ–‡ï¼šä¾‹å¦‚â€œé¸¡è›‹ç¾¹ / å°ç±³ç²¥ / banana / steakâ€ã€‚æ”¯æŒåˆ«ååŒ¹é…ã€‚",
    all:"å…¨éƒ¨",
    safe:"æ¨è",
    caution:"è°¨æ…",
    avoid:"é¿å…",
    notFoundTitle:"æœªåœ¨æœ¬åœ°ä¸´åºŠé£Ÿç‰©åº“ä¸­æ‰¾åˆ°ã€‚",
    notFoundDesc:"ä½ å¯ä»¥ç‚¹å‡»â€œé—® AI åŠ©æ‰‹â€ï¼ŒæŠŠä½ çš„å…·ä½“æƒ…å†µï¼ˆæœ¯åå‘¨æ•°ã€ç—‡çŠ¶ã€æ˜¯å¦è…¹æ³»/è„‚è‚ªæ³»ã€æ˜¯å¦åœ¨ç”¨èƒ°é…¶ï¼‰ä¸€èµ·æè¿°ï¼Œä¼šæ›´å‡†ç¡®ã€‚",
    disclaimer:"å…è´£å£°æ˜ï¼šæœ¬å·¥å…·ç”¨äºå¥åº·æ•™è‚²ä¸è‡ªæˆ‘è®°å½•ï¼Œä¸èƒ½æ›¿ä»£åŒ»ç”Ÿ/è¥å…»å¸ˆè¯Šç–—ã€‚è‹¥å‡ºç°æŒç»­å‘•åã€æ— æ³•è¿›é£Ÿã€æ˜æ˜¾è…¹ç—›ã€é»‘ä¾¿/ä¾¿è¡€ã€å¿«é€Ÿä½“é‡ä¸‹é™ç­‰ï¼Œè¯·åŠæ—¶å°±åŒ»ã€‚",
    settingsTitle:"ä¸ªæ€§åŒ–è®¾ç½®",
    settingsDesc:"ç›®æ ‡æŒ‰ä½“é‡ä¼°ç®—ï¼›ä½ å¯åœ¨å»ºè®®åŒºé—´å†…è°ƒæ•´çƒ­é‡/è›‹ç™½ç³»æ•°ï¼Œå¹¶ä¿å­˜åˆ°æœ¬æœºï¼ˆlocalStorageï¼‰ã€‚",
    weightLabel:"ä½“é‡ (kg)",
    weightTip:"ç”¨äºä¼°ç®—æ¯æ—¥èƒ½é‡ä¸è›‹ç™½ç›®æ ‡ã€‚",
    modeLabel:"æ¨¡å¼",
    modeTip:"æ¨¡å¼ä¼šå½±å“â€œé¿å…/è°¨æ…â€çš„æç¤ºæ–‡æ¡ˆï¼ˆä¸æ›¿ä»£ä¸ªä½“åŒ–åŒ»å˜±ï¼‰ã€‚",
    calFactor:"çƒ­é‡ç³»æ•° (kcal/kgÂ·d)",
    protFactor:"è›‹ç™½ç³»æ•° (g/kgÂ·d)",
    current:"å½“å‰",
    save:"ä¿å­˜å¹¶é‡æ–°è®¡ç®—",
    defaults:"æ¢å¤é»˜è®¤",
    toastAdded:"å·²åŠ å…¥è®°å½•",
    toastAvoid:"è¯¥é£Ÿç‰©æ ‡è®°ä¸ºâ€œé¿å…â€ï¼ŒæœªåŠ å…¥è®°å½•",
    toastReset:"å·²æ¸…ç©ºä»Šæ—¥è®°å½•",
    toastSaved:"è®¾ç½®å·²ä¿å­˜"
  },
  en: {
    dailyGoalsTitle:"Daily Goals",
    targetWeight:"Target weight",
    guideLabel:"Food safety tiers",
    calories:"Calories",
    protein:"Protein",
    proteinTip:"Higher protein is often emphasized during recovery; tailor to tolerance and clinician advice.",
    askAI:"Ask AI",
    searchWeb:"Search Web",
    reset:"Reset Today",
    foodGuideTitle:"Food Safety Guide",
    searchHint:"Type Chinese or English, e.g., congee / steamed fish / yogurt. Alias matching supported.",
    all:"All",
    safe:"Recommended",
    caution:"Use caution",
    avoid:"Avoid",
    notFoundTitle:"Not found in local clinical food list.",
    notFoundDesc:"Use â€œAsk AIâ€ and include your context (post-op weeks, symptoms, diarrhea/steatorrhea, enzymes) for better guidance.",
    disclaimer:"Disclaimer: Education & self-tracking only; not medical advice. Seek care for severe/persistent symptoms.",
    settingsTitle:"Personal Settings",
    settingsDesc:"Targets are weight-based estimates. Adjust calorie/protein factors within typical ranges and save locally.",
    weightLabel:"Weight (kg)",
    weightTip:"Used to estimate calorie and protein targets.",
    modeLabel:"Mode",
    modeTip:"Mode changes caution messaging (does not replace individualized advice).",
    calFactor:"Calorie factor (kcal/kgÂ·day)",
    protFactor:"Protein factor (g/kgÂ·day)",
    current:"Current",
    save:"Save & Recalculate",
    defaults:"Restore Defaults",
    toastAdded:"Added to today",
    toastAvoid:"Marked as Avoid â€” not added",
    toastReset:"Today reset",
    toastSaved:"Settings saved"
  }
};

let lang = localStorage.getItem("pcare_lang") || "zh";
function applyLang(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    el.textContent = i18n[lang][key] || el.textContent;
  });
  document.getElementById("langLabel").textContent = (lang==="zh" ? "ä¸­æ–‡" : "EN");
  document.getElementById("foodSearch").placeholder = (lang==="zh"
    ? "æˆ‘èƒ½åƒâ€¦ï¼ˆå¦‚ï¼šå°ç±³ç²¥ / è’¸é±¼ / yogurtï¼‰"
    : "Can I eatâ€¦ (e.g., congee / steamed fish / yogurt)");
}

/** =========================
 *  1) Food DBï¼ˆä¸­è‹±+åˆ«åï¼‰
 *  status: safe | caution | avoid
 *  stage: early | stable | bothï¼ˆç”¨äºæ¨¡å¼æç¤ºï¼‰
 *  ========================= */
const foodDB = [
  // â€”â€” åŠæµè´¨/è½¯é£Ÿ/æ˜“æ¶ˆåŒ–ï¼ˆæ›´åâ€œæ¨èâ€ï¼‰â€”â€”
  { nameZh:"å°ç±³ç²¥", nameEn:"Millet congee", status:"safe", stage:"early", cal:110, protein:3,
    aliases:["å°ç±³ç¨€é¥­","ç²¥","ç±³ç²¥","ç¨€é¥­","millet","congee"],
    noteZh:"å°‘é‡å¤šé¤ï¼Œæ¸©çƒ­æ›´æ˜“è€å—ï¼›å¯é€æ­¥å¢åŠ æµ“ç¨ åº¦ã€‚",
    noteEn:"Small frequent meals; warm and thin texture is usually better tolerated early on."
  },
  { nameZh:"å¤§ç±³ç²¥/ç™½ç²¥", nameEn:"Rice congee", status:"safe", stage:"early", cal:120, protein:2,
    aliases:["ç™½ç²¥","å¤§ç±³ç¨€é¥­","ç¨€ç²¥","rice congee","congee"],
    noteZh:"ä½çº¤ç»´ã€æ˜“æ¶ˆåŒ–ï¼›æ—©æœŸå¸¸æ›´åˆé€‚ã€‚",
    noteEn:"Low fiber and easy to digest; often preferred early."
  },
  { nameZh:"é¢æ±¤/æ¸…æ±¤é¢ï¼ˆå°‘æ²¹ï¼‰", nameEn:"Noodle soup (low oil)", status:"safe", stage:"early", cal:180, protein:6,
    aliases:["é¢æ±¤","æ±¤é¢","æ¸…æ±¤é¢","æŒ‚é¢","noodle soup","noodles"],
    noteZh:"é€‰æ‹©å°‘æ²¹ã€å°‘åˆºæ¿€è°ƒå‘³ï¼›æ…¢æ…¢åƒã€‚",
    noteEn:"Keep it low oil and non-spicy; eat slowly."
  },
  { nameZh:"é¸¡è›‹ç¾¹/è’¸è›‹", nameEn:"Steamed egg custard", status:"safe", stage:"early", cal:90, protein:7,
    aliases:["è’¸è›‹","è›‹ç¾¹","é¸¡è›‹ç¾¹","custard","steamed egg","egg"],
    noteZh:"ä¼˜è´¨è›‹ç™½ï¼Œå£æ„Ÿè½¯ï¼›é¿å…è¿‡å¤šæ²¹è„‚ã€‚",
    noteEn:"Soft texture and good protein; avoid heavy oil."
  },
  { nameZh:"æ°´ç…®/æ¸…è’¸é¸¡èƒ¸è‚‰", nameEn:"Boiled/steamed chicken breast", status:"safe", stage:"both", cal:165, protein:31,
    aliases:["é¸¡èƒ¸è‚‰","æ¸…è’¸é¸¡","ç™½åˆ‡é¸¡(å»çš®)","boiled chicken","chicken breast"],
    noteZh:"ç˜¦è‚‰é«˜è›‹ç™½ï¼›å°½é‡å»çš®ã€é¿å…æ²¹ç‚¸ã€‚",
    noteEn:"Lean high-protein; remove skin and avoid frying."
  },
  { nameZh:"æ¸…è’¸ç™½è‚‰é±¼ï¼ˆé³•é±¼/é²ˆé±¼ï¼‰", nameEn:"Steamed white fish", status:"safe", stage:"both", cal:120, protein:22,
    aliases:["æ¸…è’¸é±¼","è’¸é±¼","ç™½è‚‰é±¼","é³•é±¼","é²ˆé±¼","cod","sea bass","fish"],
    noteZh:"ä½è„‚é«˜è›‹ç™½ï¼›æ¸…è’¸æ›´å®¹æ˜“è€å—ã€‚",
    noteEn:"Low fat, high-quality protein; steaming is usually well tolerated."
  },
  { nameZh:"å«©è±†è…/è±†è…è„‘ï¼ˆå°‘å¤ï¼‰", nameEn:"Soft tofu", status:"safe", stage:"both", cal:90, protein:8,
    aliases:["è±†è…","å«©è±†è…","è±†è…è„‘","tofu","bean curd"],
    noteZh:"æ¤ç‰©è›‹ç™½ï¼Œè´¨åœ°è½¯ï¼›é¿å…é‡å£å‘³/è¾›è¾£å¤æ±ã€‚",
    noteEn:"Soft plant protein; avoid spicy/heavy seasoning."
  },
  { nameZh:"è™¾æ»‘/é±¼ä¸¸æ±¤ï¼ˆæ¸…æ·¡ï¼‰", nameEn:"Shrimp paste / fish ball soup (light)", status:"safe", stage:"early", cal:140, protein:12,
    aliases:["è™¾æ»‘","é±¼ä¸¸","é±¼ä¸¸æ±¤","æ¸…æ±¤é±¼ä¸¸","shrimp paste","fish balls"],
    noteZh:"è´¨åœ°è½¯ã€æ˜“åå’½ï¼›æ³¨æ„ç›åˆ†ä¸æ²¹è„‚ã€‚",
    noteEn:"Soft texture; keep it light in salt and oil."
  },
  { nameZh:"é…¸å¥¶ï¼ˆä½è„‚/æ— ä¹³ç³–ä¼˜å…ˆï¼‰", nameEn:"Yogurt (low-fat)", status:"caution", stage:"both", cal:90, protein:8,
    aliases:["é…¸å¥¶","æ— ä¹³ç³–é…¸å¥¶","yogurt"],
    noteZh:"è‹¥ä¹³ç³–ä¸è€/è…¹æ³»éœ€è°¨æ…ï¼Œå¯é€‰æ— ä¹³ç³–ã€‚",
    noteEn:"Use caution with lactose intolerance/diarrhea; consider lactose-free."
  },

  // â€”â€” äº§æ°”/é«˜çº¤ç»´/åˆºæ¿€æ€§ï¼ˆè°¨æ…ï¼‰â€”â€”
  { nameZh:"è¥¿å…°èŠ±/å·å¿ƒèœ/èœèŠ±", nameEn:"Broccoli/cabbage/cauliflower", status:"caution", stage:"early", cal:35, protein:3,
    aliases:["è¥¿å…°èŠ±","èŠ±æ¤°èœ","èœèŠ±","å·å¿ƒèœ","åŒ…èœ","broccoli","cabbage","cauliflower"],
    noteZh:"æ˜“äº§æ°”èƒ€ï¼›æ—©æœŸæ›´å¸¸ä¸è€å—ï¼Œå»ºè®®åæœŸå°‘é‡å°è¯•ã€‚",
    noteEn:"Gas-producing; often poorly tolerated early. Reintroduce slowly later."
  },
  { nameZh:"æ´‹è‘±ï¼ˆå°¤å…¶ç”Ÿï¼‰", nameEn:"Onion (especially raw)", status:"caution", stage:"early", cal:40, protein:1,
    aliases:["æ´‹è‘±","ç”Ÿæ´‹è‘±","onion","raw onion"],
    noteZh:"æ˜“èƒ€æ°”/åˆºæ¿€ï¼›æ—©æœŸæ›´å»ºè®®é¿å…ã€‚",
    noteEn:"Can cause gas/irritation; avoid early."
  },
  { nameZh:"åšæœï¼ˆæ•´é¢—ï¼‰", nameEn:"Whole nuts", status:"caution", stage:"both", cal:170, protein:6,
    aliases:["åšæœ","èŠ±ç”Ÿ","æ ¸æ¡ƒ","æä»","nuts","peanuts","almond","walnut"],
    noteZh:"åç¡¬ä¸”è„‚è‚ªé«˜ï¼Œæ˜“ä¸è€å—ï¼›å¯è€ƒè™‘å°‘é‡é¡ºæ»‘åšæœé…±ã€‚",
    noteEn:"Hard and higher-fat; consider small amounts of smooth nut butter."
  },

  // â€”â€” å»ºè®®é¿å…ï¼ˆé«˜è„‚ã€æ²¹ç‚¸ã€è¾›è¾£ã€ç¢³é…¸ã€ç”Ÿå†·é«˜çº¤ç»´ç­‰ï¼‰â€”â€”
  { nameZh:"æ²¹ç‚¸é£Ÿç‰©ï¼ˆç‚¸é¸¡/è–¯æ¡ï¼‰", nameEn:"Fried foods (fried chicken/fries)", status:"avoid", stage:"both", cal:320, protein:15,
    aliases:["æ²¹ç‚¸","ç‚¸é¸¡","è–¯æ¡","fried","fries","fried chicken"],
    noteZh:"é«˜è„‚éš¾æ¶ˆåŒ–ï¼Œèƒ°è…ºç›¸å…³äººç¾¤æ›´æ˜“ä¸é€‚ã€‚",
    noteEn:"High fat and harder to digest."
  },
  { nameZh:"è¾›è¾£åˆºæ¿€ï¼ˆè¾£ç«é”…/éº»è¾£/è¾£è±†è…ï¼‰", nameEn:"Spicy foods", status:"avoid", stage:"both", cal:200, protein:8,
    aliases:["è¾›è¾£","éº»è¾£","ç«é”…","è¾£","spicy","hot pot"],
    noteZh:"åˆºæ¿€æ€§å¼ºï¼Œå¯èƒ½åŠ é‡ä¸é€‚ã€‚",
    noteEn:"Can aggravate GI discomfort."
  },
  { nameZh:"ç”Ÿå†·è”¬èœ/æ²™æ‹‰", nameEn:"Raw vegetables/salad", status:"avoid", stage:"early", cal:20, protein:2,
    aliases:["æ²™æ‹‰","ç”Ÿèœ","ç”Ÿå†·","raw salad","salad","raw vegetables"],
    noteZh:"çº¤ç»´é«˜ã€æ—©æœŸæ›´éš¾è€å—ï¼›å»ºè®®å……åˆ†ç…®ç†Ÿå†å°è¯•ã€‚",
    noteEn:"High fiber; often poorly tolerated early. Prefer well-cooked vegetables."
  },
  { nameZh:"ç¢³é…¸é¥®æ–™", nameEn:"Carbonated drinks", status:"avoid", stage:"both", cal:140, protein:0,
    aliases:["æ±½æ°´","å¯ä¹","è‹æ‰“æ°´","æ°”æ³¡æ°´","carbonated","soda","sparkling water"],
    noteZh:"æ˜“èƒ€æ°”ã€æ—©é¥±æ„Ÿæ›´æ˜æ˜¾ã€‚",
    noteEn:"Can increase gas and fullness."
  },
  { nameZh:"ç”œç‚¹/é«˜ç³–è›‹ç³•", nameEn:"Sugary desserts/cake", status:"avoid", stage:"both", cal:260, protein:3,
    aliases:["è›‹ç³•","ç”œç‚¹","å¥¶èŒ¶(é«˜ç³–)","dessert","cake","sweet"],
    noteZh:"é«˜ç³–å¯èƒ½åŠ é‡è¡€ç³–æ³¢åŠ¨ä¸ä¸é€‚ï¼›æ›´å»ºè®®åˆ†æ¬¡ã€ä½ç³–æ›¿ä»£ã€‚",
    noteEn:"High sugar may worsen glucose swings and symptoms."
  },
  { nameZh:"è‚¥è‚‰/é«˜è„‚çº¢è‚‰ï¼ˆè‚¥ç‰›è‚¥ç¾Š/äº”èŠ±è‚‰ï¼‰", nameEn:"Fatty red meat", status:"avoid", stage:"both", cal:320, protein:20,
    aliases:["çº¢è‚‰","ç‰›æ’(è‚¥)","äº”èŠ±è‚‰","è‚¥è‚‰","fatty pork","fatty beef","steak"],
    noteZh:"è„‚è‚ªé«˜æ›´éš¾æ¶ˆåŒ–ï¼›ä¼˜å…ˆé€‰æ‹©é±¼/ç¦½ç±»ç˜¦è‚‰ã€‚",
    noteEn:"Higher fat and harder to digest; prefer lean poultry/fish."
  }
];

/** =========================
 *  2) State
 *  ========================= */
const LS = {
  weight: "pcare_weight",
  calPerKg: "pcare_cal_perkg",
  protPerKg: "pcare_prot_perkg",
  mode: "pcare_mode",
  stats: "pcare_today_stats",
  lang: "pcare_lang"
};

let userWeight = 60;
let calPerKg = 30;     // default in common guideline band
let protPerKg = 1.5;   // within 1.2â€“2.0 band
let mode = "sensitive";
let dailyStats = { cal: 0, prot: 0 };
let filterStatus = "all";

/** =========================
 *  3) Helpers
 *  ========================= */
function showToast(message, type="ok"){
  const toast = document.getElementById("toast");
  const msg = document.getElementById("toastMsg");
  const icon = toast.querySelector("i");
  msg.textContent = message;

  icon.className = "fa-solid " + (type==="warn" ? "fa-triangle-exclamation text-amber-300"
    : type==="bad" ? "fa-circle-xmark text-red-300"
    : "fa-circle-check text-green-300");

  toast.classList.remove("hidden");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> toast.classList.add("hidden"), 2200);
}

function normalize(s){
  return (s||"").toString().trim().toLowerCase();
}

function getDisplayName(item){
  return (lang==="zh") ? item.nameZh : item.nameEn;
}
function getNote(item){
  return (lang==="zh") ? item.noteZh : item.noteEn;
}
function statusBadge(status){
  if(status==="safe") return `<span class="badge badge-safe">${lang==="zh"?"æ¨è":"Recommended"}</span>`;
  if(status==="caution") return `<span class="badge badge-caution">${lang==="zh"?"è°¨æ…":"Caution"}</span>`;
  return `<span class="badge badge-avoid">${lang==="zh"?"é¿å…":"Avoid"}</span>`;
}
function leftClass(status){
  if(status==="safe") return "food-left-safe";
  if(status==="caution") return "food-left-caution";
  return "food-left-avoid";
}

/** =========================
 *  4) Rendering
 *  ========================= */
function updateDashboard(){
  const calTarget = Math.round(userWeight * calPerKg);
  const protTarget = Math.round(userWeight * protPerKg);

  document.getElementById("targetWeightDisplay").textContent = userWeight;
  document.getElementById("calTarget").textContent = calTarget;
  document.getElementById("protTarget").textContent = protTarget;

  document.getElementById("calCurrent").textContent = dailyStats.cal;
  document.getElementById("protCurrent").textContent = dailyStats.prot;

  document.getElementById("calBar").style.width = Math.min((dailyStats.cal / calTarget) * 100, 100) + "%";
  document.getElementById("protBar").style.width = Math.min((dailyStats.prot / protTarget) * 100, 100) + "%";

  document.getElementById("mealModeLabel").textContent = (mode==="sensitive"
    ? (lang==="zh" ? "æœ¯å/æ¶ˆåŒ–æ•æ„Ÿ" : "Post-op / sensitive")
    : (lang==="zh" ? "ç›¸å¯¹ç¨³å®š" : "More stable")
  );
}

function renderFoods(list){
  const container = document.getElementById("foodList");
  container.innerHTML = "";

  if(list.length === 0){
    document.getElementById("notFound").classList.remove("hidden");
    return;
  }
  document.getElementById("notFound").classList.add("hidden");

  list.forEach(item=>{
    const status = item.status;
    const icon = status==="safe" ? "fa-circle-check text-green-600"
      : status==="caution" ? "fa-triangle-exclamation text-amber-600"
      : "fa-circle-xmark text-red-600";

    const canAdd = status !== "avoid";
    const btn = canAdd
      ? `<button class="btn-ghost px-3 py-2 rounded-xl text-sm font-extrabold"
                 onclick="addFood('${escapeQuotes(getDisplayName(item))}', ${item.cal}, ${item.protein}, '${status}')">
            <i class="fa-solid fa-plus mr-2"></i>${lang==="zh"?"åŠ å…¥":"Add"}
         </button>`
      : `<span class="text-xs font-extrabold uppercase text-red-500">${lang==="zh"?"é¿å…":"AVOID"}</span>`;

    const stageHint = (mode==="sensitive" && item.stage==="stable")
      ? (lang==="zh" ? "ï¼ˆæ›´ååæœŸï¼‰" : "(later stage)")
      : "";

    const div = document.createElement("div");
    div.className = `card ${leftClass(status)} p-4 sm:p-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3`;
    div.innerHTML = `
      <div class="flex-1">
        <div class="flex items-start gap-3">
          <i class="fa-solid ${icon} text-lg mt-0.5"></i>
          <div>
            <div class="flex flex-wrap items-center gap-2">
              <h4 class="font-extrabold text-slate-900">${getDisplayName(item)} ${stageHint}</h4>
              ${statusBadge(status)}
            </div>
            <p class="text-sm text-slate-600 mt-1">${getNote(item)}</p>
            <p class="text-xs text-slate-500 mt-2 flex flex-wrap gap-x-4 gap-y-1">
              <span>ğŸ”¥ ${item.cal} kcal</span>
              <span>ğŸ¥© ${item.protein} g</span>
              <span class="text-slate-400">${lang==="zh"?"åˆ«å":"Aliases"}: ${(item.aliases||[]).slice(0,4).join(" / ")}${(item.aliases||[]).length>4?"â€¦":""}</span>
            </p>
          </div>
        </div>
      </div>
      <div class="shrink-0 flex items-center justify-end">
        ${btn}
      </div>
    `;
    container.appendChild(div);
  });
}

function escapeQuotes(s){
  return (s||"").replace(/'/g,"\\'").replace(/"/g,'&quot;');
}

/** =========================
 *  5) Search / Filter
 *  ========================= */
function matchFood(item, q){
  if(!q) return true;
  const hay = [
    item.nameZh, item.nameEn,
    ...(item.aliases || [])
  ].map(normalize).join(" ");
  return hay.includes(q);
}

function refresh(){
  const q = normalize(document.getElementById("foodSearch").value);
  const list = foodDB
    .filter(item => (filterStatus==="all" ? true : item.status===filterStatus))
    .filter(item => matchFood(item, q));

  renderFoods(list);
}

function setFilter(status){
  filterStatus = status;
  ["fltAll","fltSafe","fltCaution","fltAvoid"].forEach(id=>{
    document.getElementById(id).classList.remove("ring-2","ring-blue-200");
  });
  const map = {all:"fltAll", safe:"fltSafe", caution:"fltCaution", avoid:"fltAvoid"};
  document.getElementById(map[status]).classList.add("ring-2","ring-blue-200");
  refresh();
}

/** =========================
 *  6) Actions
 *  ========================= */
function addFood(name, cal, prot, status){
  if(status==="avoid"){
    showToast(i18n[lang].toastAvoid, "bad");
    return;
  }
  dailyStats.cal += cal;
  dailyStats.prot += prot;
  localStorage.setItem(LS.stats, JSON.stringify(dailyStats));
  updateDashboard();
  showToast(`${i18n[lang].toastAdded}: ${name}`);
}

function resetToday(){
  dailyStats = { cal: 0, prot: 0 };
  localStorage.setItem(LS.stats, JSON.stringify(dailyStats));
  updateDashboard();
  showToast(i18n[lang].toastReset, "warn");
}

/** =========================
 *  7) AI / Search
 *  ========================= */
function askAI(){
  const query = document.getElementById("foodSearch").value.trim() || (lang==="zh" ? "è¿™ä¸ªé£Ÿç‰©" : "this item");
  const contextZh = "æˆ‘/å®¶äººæ˜¯èƒ°è…ºç™Œæˆ–èƒ°è…ºæœ¯åæ‚£è€…ã€‚è¯·æ ¹æ®å¾ªè¯æ‚£è€…æ•™è‚²è¦ç‚¹ç»™å‡ºæ˜¯å¦é€‚åˆé£Ÿç”¨ã€å»ºè®®ä»½é‡ã€åšæ³•ï¼ˆå°‘æ²¹ã€è½¯çƒ‚ã€å°‘é‡å¤šé¤ï¼‰ã€ä»¥åŠå¯èƒ½ä¸è€å—é£é™©ï¼ˆé«˜è„‚ã€é«˜çº¤ç»´ã€äº§æ°”ã€è¾›è¾£ã€ç¢³é…¸ã€ä¹³ç³–ç­‰ï¼‰ã€‚å¦‚éœ€èƒ°é…¶/è…¹æ³»/è„‚è‚ªæ³»æç¤ºä¹Ÿè¯·è¯´æ˜ã€‚";
  const contextEn = "I am (or my family is) a pancreatic cancer patient or post-pancreatic surgery patient. Please advise if it is safe, portion size, cooking method (low oil, soft texture, small frequent meals), and intolerance risks (fat, fiber, gas, spicy, carbonated, lactose). Mention enzyme/diarrhea/steatorrhea considerations if relevant.";
  const prompt = (lang==="zh")
    ? `${contextZh}\né—®é¢˜ï¼š${query} å¯ä»¥åƒå—ï¼Ÿ`
    : `${contextEn}\nQuestion: Is ${query} safe to eat?`;

  if(confirm((lang==="zh"?"æ‰“å¼€ AI åŠ©æ‰‹å¹¶å¸¦å…¥é—®é¢˜ï¼Ÿ":"Open AI with the prompt?") + `\n\n${prompt}`)){
    window.open(`https://chatgpt.com/?q=${encodeURIComponent(prompt)}`, "_blank");
  }
}

function googleSearch(){
  const query = document.getElementById("foodSearch").value.trim() || (lang==="zh"?"èƒ°è…ºæœ¯å é¥®é£Ÿ":"pancreatic post-op diet");
  const finalQuery = (lang==="zh")
    ? `èƒ°è…º æ‰‹æœ¯ å é¥®é£Ÿ ${query} èƒ½ä¸èƒ½åƒ`
    : `pancreatic surgery diet can I eat ${query}`;
  window.open(`https://www.google.com/search?q=${encodeURIComponent(finalQuery)}`, "_blank");
}

/** =========================
 *  8) Settings
 *  ========================= */
function openSettings(){
  document.getElementById("settingsModal").classList.remove("hidden");
  document.getElementById("settingsModal").classList.add("flex");
}
function closeSettings(){
  document.getElementById("settingsModal").classList.add("hidden");
  document.getElementById("settingsModal").classList.remove("flex");
}

function syncSettingsUI(){
  document.getElementById("weightInput").value = userWeight;
  document.getElementById("calPerKgInput").value = calPerKg;
  document.getElementById("protPerKgInput").value = protPerKg;
  document.getElementById("modeInput").value = mode;

  document.getElementById("calPerKgLabel").textContent = calPerKg;
  document.getElementById("protPerKgLabel").textContent = protPerKg.toFixed(1);
}

function saveSettings(){
  const w = parseFloat(document.getElementById("weightInput").value);
  const c = parseFloat(document.getElementById("calPerKgInput").value);
  const p = parseFloat(document.getElementById("protPerKgInput").value);
  const m = document.getElementById("modeInput").value;

  if(!w || w<20 || w>200){
    showToast(lang==="zh" ? "è¯·è¾“å…¥åˆç†ä½“é‡ï¼ˆ20â€“200kgï¼‰" : "Enter a valid weight (20â€“200kg)", "warn");
    return;
  }
  userWeight = Math.round(w);
  calPerKg = Math.round(c);
  protPerKg = Math.round(p*10)/10;
  mode = m;

  localStorage.setItem(LS.weight, userWeight);
  localStorage.setItem(LS.calPerKg, calPerKg);
  localStorage.setItem(LS.protPerKg, protPerKg);
  localStorage.setItem(LS.mode, mode);

  updateDashboard();
  closeSettings();
  showToast(i18n[lang].toastSaved);
}

function restoreDefaults(){
  userWeight = 60;
  calPerKg = 30;
  protPerKg = 1.5;
  mode = "sensitive";
  syncSettingsUI();
  updateDashboard();
}

/** =========================
 *  9) Init
 *  ========================= */
function init(){
  // Load persisted state
  const sw = localStorage.getItem(LS.weight);
  const sc = localStorage.getItem(LS.calPerKg);
  const sp = localStorage.getItem(LS.protPerKg);
  const sm = localStorage.getItem(LS.mode);
  const ss = localStorage.getItem(LS.stats);

  if(sw) userWeight = parseInt(sw,10);
  if(sc) calPerKg = parseInt(sc,10);
  if(sp) protPerKg = parseFloat(sp);
  if(sm) mode = sm;
  if(ss) {
    try{ dailyStats = JSON.parse(ss) || dailyStats; }catch(e){}
  }

  // Settings sliders label update
  document.getElementById("calPerKgInput").addEventListener("input", e=>{
    document.getElementById("calPerKgLabel").textContent = e.target.value;
  });
  document.getElementById("protPerKgInput").addEventListener("input", e=>{
    document.getElementById("protPerKgLabel").textContent = parseFloat(e.target.value).toFixed(1);
  });

  // Enter key quick-add
  document.getElementById("foodSearch").addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){
      const q = normalize(document.getElementById("foodSearch").value);
      const list = foodDB
        .filter(item => (filterStatus==="all" ? true : item.status===filterStatus))
        .filter(item => matchFood(item, q));
      if(list.length>0){
        const item = list[0];
        addFood(getDisplayName(item), item.cal, item.protein, item.status);
      }
    }
  });

  // Language toggle
  document.getElementById("btnLang").addEventListener("click", ()=>{
    lang = (lang==="zh") ? "en" : "zh";
    localStorage.setItem(LS.lang, lang);
    applyLang();
    refresh();
    updateDashboard();
  });

  applyLang();
  syncSettingsUI();
  updateDashboard();
  setFilter("all");
  refresh();
}

init();
</script>
</body>
</html>
