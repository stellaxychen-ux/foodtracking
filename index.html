<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>P‑Care | 胰腺营养助手</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50:  "#e9fff4",
              100: "#c9ffe1",
              200: "#8fffc1",
              300: "#56f3a1",
              400: "#26d980",
              500: "#12b76a",
              600: "#0e8f53",
              700: "#0d6f43",
              800: "#0c5637",
              900: "#0b472f"
            }
          },
          boxShadow: {
            soft: "0 8px 30px rgba(2, 6, 23, 0.08)"
          }
        }
      }
    }
  </script>

  <!-- Icons -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>

  <!-- Chart.js (for Analysis popup) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root { color-scheme: light; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Noto Sans SC", "Microsoft YaHei", Arial, sans-serif; }
    .glass { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    .card { background: rgba(255,255,255,0.92); border: 1px solid rgba(15, 23, 42, 0.06); border-radius: 18px; }
    .tag { border-radius: 999px; padding: 2px 10px; font-size: 12px; font-weight: 700; }
    .tag-safe { background: #e9fff4; color: #0e8f53; border: 1px solid rgba(18,183,106,.25); }
    .tag-caution { background: #fff8e1; color: #a16207; border: 1px solid rgba(161,98,7,.25); }
    .tag-avoid { background: #ffecec; color: #b42318; border: 1px solid rgba(180,35,24,.22); }
    .food-safe { border-left: 6px solid #12b76a; }
    .food-caution { border-left: 6px solid #f59e0b; }
    .food-avoid { border-left: 6px solid #ef4444; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 pb-24">
  <!-- Top Bar -->
  <header class="sticky top-0 z-40">
    <div class="bg-white/70 glass border-b border-slate-100">
      <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-brand-500 text-white flex items-center justify-center shadow-soft">
            <span class="text-lg">🥬</span>
          </div>
          <div>
            <h1 class="text-xl font-extrabold tracking-tight">P‑Care</h1>
            <p class="text-xs text-slate-500">胰腺营养 & 食物安全助手 · Evidence‑informed</p>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="btnAnalysis" class="px-3 py-2 rounded-xl bg-brand-50 border border-brand-100 text-brand-700 font-semibold hover:bg-brand-100">
            <i class="fa-solid fa-chart-pie mr-2"></i>分析
          </button>
          <button id="btnSettings" class="w-10 h-10 rounded-xl bg-white border border-slate-100 hover:bg-slate-50">
            <i class="fa-solid fa-gear text-slate-500"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 pt-5 space-y-5">
    <!-- Summary / Goals -->
    <section class="card shadow-soft p-5">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="text-lg font-bold">今日目标 🎯</h2>
          <p class="text-sm text-slate-500 mt-1">
            目标会根据体重自动计算；可在设置中调整。
          </p>
          <p class="text-xs text-slate-500 mt-2">
            * 胰腺癌营养：推荐能量 25–30 kcal/(kg·d)，蛋白质 1.2–2.0 g/(kg·d)。<span class="text-slate-400">(见“信息来源”)</span>
          </p>
        </div>

        <div class="text-right">
          <div class="text-xs text-slate-500">目标体重</div>
          <div class="text-2xl font-extrabold"><span id="targetWeightDisplay">--</span><span class="text-base font-bold text-slate-500"> kg</span></div>
          <div class="text-xs text-slate-500 mt-1"><span id="dietModeBadge" class="tag tag-safe">默认：术后/消化友好</span></div>
        </div>
      </div>

      <div class="mt-5 grid md:grid-cols-2 gap-4">
        <!-- Calories -->
        <div class="p-4 rounded-2xl bg-white border border-slate-100">
          <div class="flex items-center justify-between text-sm mb-2">
            <span class="text-slate-600 font-semibold"><i class="fa-solid fa-fire mr-2 text-orange-500"></i>热量</span>
            <span class="font-extrabold"><span id="calCurrent">0</span> / <span id="calTarget">0</span> kcal</span>
          </div>
          <div class="w-full bg-slate-100 rounded-full h-3">
            <div id="calBar" class="bg-orange-400 h-3 rounded-full" style="width:0%"></div>
          </div>
          <div class="flex items-center justify-between mt-2 text-xs text-slate-500">
            <span>✅ 少量多餐更舒适</span>
            <span id="calPct">0%</span>
          </div>
        </div>

        <!-- Protein -->
        <div class="p-4 rounded-2xl bg-white border border-slate-100">
          <div class="flex items-center justify-between text-sm mb-2">
            <span class="text-slate-600 font-semibold"><i class="fa-solid fa-drumstick-bite mr-2 text-brand-600"></i>蛋白质</span>
            <span class="font-extrabold"><span id="protCurrent">0</span> / <span id="protTarget">0</span> g</span>
          </div>
          <div class="w-full bg-slate-100 rounded-full h-3">
            <div id="protBar" class="bg-brand-500 h-3 rounded-full" style="width:0%"></div>
          </div>
          <div class="flex items-center justify-between mt-2 text-xs text-slate-500">
            <span>💪 恢复期蛋白很关键</span>
            <span id="protPct">0%</span>
          </div>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="mt-5 grid sm:grid-cols-3 gap-3">
        <button id="btnAddCustom" class="py-3 rounded-2xl bg-white border border-slate-100 font-semibold hover:bg-slate-50">
          ➕ 记录自定义食物
        </button>
        <button id="btnImport" class="py-3 rounded-2xl bg-white border border-slate-100 font-semibold hover:bg-slate-50">
          📥 导入数据库(JSON)
        </button>
        <button id="btnResetDay" class="py-3 rounded-2xl bg-white border border-slate-100 font-semibold hover:bg-slate-50">
          🔄 清空今日记录
        </button>
      </div>

      <!-- Source note -->
      <div class="mt-4 text-xs text-slate-500">
        信息来源：胰腺癌营养治疗专家共识（2022）与 Whipple 术后饮食建议（中文译版）。详情见设置里的“来源说明”。
      </div>
    </section>

    <!-- Search -->
    <section class="card shadow-soft p-5">
      <div class="flex items-center justify-between gap-3">
        <h3 class="text-lg font-bold">食物安全查询 🔎</h3>
        <div class="text-xs text-slate-500">支持：中文 / 拼音 / 英文别名</div>
      </div>

      <div class="mt-3 relative">
        <input id="foodSearch" type="text" placeholder="我能吃什么？例如：香蕉 / 小米粥 / 鸡胸肉 / 豆腐" class="w-full p-4 pr-12 rounded-2xl border border-slate-100 shadow-sm focus:ring-4 focus:ring-brand-100 outline-none"/>
        <i class="fa-solid fa-magnifying-glass absolute right-4 top-5 text-slate-400"></i>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button data-filter="all" class="filterBtn px-3 py-2 rounded-xl bg-brand-50 text-brand-700 border border-brand-100 font-semibold">全部</button>
        <button data-filter="safe" class="filterBtn px-3 py-2 rounded-xl bg-white border border-slate-100 font-semibold">✅ 适合</button>
        <button data-filter="caution" class="filterBtn px-3 py-2 rounded-xl bg-white border border-slate-100 font-semibold">⚠️ 谨慎</button>
        <button data-filter="avoid" class="filterBtn px-3 py-2 rounded-xl bg-white border border-slate-100 font-semibold">⛔ 避免</button>
      </div>

      <div id="foodList" class="mt-4 space-y-3"></div>

      <div id="notFound" class="hidden mt-4 p-6 rounded-2xl bg-slate-50 border border-slate-100 text-center">
        <div class="text-2xl">🤔</div>
        <p class="mt-2 text-slate-700 font-semibold">数据库里暂时没有这个食物</p>
        <p class="mt-1 text-sm text-slate-500">你可以先用“自定义食物”记录，或者导入更多文献整理后的 JSON。</p>
      </div>
    </section>

    <!-- Footer helper -->
    <section class="p-1">
      <div class="text-xs text-slate-500 text-center">
        ⚠️ 本工具用于营养记录与科普，不替代医生/营养师建议；有吞咽困难、持续腹泻、严重腹胀/呕吐请及时就医。
      </div>
    </section>
  </main>

  <!-- SETTINGS MODAL -->
  <div id="settingsModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="w-[92vw] max-w-lg bg-white rounded-3xl shadow-soft border border-slate-100 overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
        <div class="font-extrabold text-lg">设置 ⚙️</div>
        <button class="closeModal w-10 h-10 rounded-xl hover:bg-slate-50"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="p-5 space-y-5">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-2">体重 (kg)</label>
            <input id="weightInput" type="number" min="20" max="200" class="w-full p-3 rounded-xl border border-slate-200 focus:ring-4 focus:ring-brand-100 outline-none" value="60"/>
          </div>
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-2">模式</label>
            <select id="dietMode" class="w-full p-3 rounded-xl border border-slate-200 focus:ring-4 focus:ring-brand-100 outline-none">
              <option value="postop">术后/消化友好（默认）</option>
              <option value="chemo">放化疗中（更偏向高蛋白/易消化）</option>
              <option value="general">一般随访（更均衡）</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-2">热量系数 kcal/kg/天</label>
            <input id="calPerKg" type="number" step="1" min="15" max="45" class="w-full p-3 rounded-xl border border-slate-200 focus:ring-4 focus:ring-brand-100 outline-none"/>
            <p class="text-xs text-slate-500 mt-2">胰腺癌共识推荐 25–30；有并发症可到 30–35。</p>
          </div>
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-2">蛋白系数 g/kg/天</label>
            <input id="protPerKg" type="number" step="0.1" min="0.6" max="2.5" class="w-full p-3 rounded-xl border border-slate-200 focus:ring-4 focus:ring-brand-100 outline-none"/>
            <p class="text-xs text-slate-500 mt-2">胰腺癌共识推荐 1.2–2.0。</p>
          </div>
        </div>

        <div class="p-4 rounded-2xl bg-slate-50 border border-slate-100">
          <div class="font-bold">WHO 参考（一般成人）🌍</div>
          <ul class="mt-2 text-sm text-slate-600 list-disc pl-5 space-y-1">
            <li>总脂肪：&lt; 30% 能量；饱和脂肪 &lt; 10% 能量；反式脂肪 &lt; 1% 能量（一般健康建议）。</li>
            <li>添加糖：&lt; 10% 能量（更理想 &lt; 5%）。</li>
            <li>食盐：&lt; 5g/天（约 2g 钠）。</li>
            <li>果蔬：≥ 400g/天。</li>
          </ul>
          <p class="text-xs text-slate-500 mt-2">
            说明：以上是“人群一般建议”。胰腺癌/术后个体需求差异很大，请以临床团队建议为准。
          </p>
        </div>

        <details class="p-4 rounded-2xl bg-white border border-slate-100">
          <summary class="cursor-pointer font-bold text-slate-800">信息来源说明（你上传的文献）</summary>
          <div class="mt-3 text-sm text-slate-600 space-y-2">
            <p>
              • 胰腺癌营养治疗专家共识（2022）：能量 25–30 kcal/(kg·d)，蛋白质 1.2–2.0 g/(kg·d)，并发症可 30–35 kcal/(kg·d)。
            </p>
            <p>
              • Whipple 术后饮食：少量多餐（每 2–3 小时一次）、以蛋白质为主、避免高脂油炸、碳酸饮料，以及部分易产气食物（如卷心菜、花椰菜、豆类等）。
            </p>
          </div>
        </details>

        <div class="flex gap-3">
          <button id="saveSettings" class="flex-1 py-3 rounded-2xl bg-brand-600 hover:bg-brand-700 text-white font-extrabold">保存并重算 ✅</button>
          <button class="closeModal flex-1 py-3 rounded-2xl bg-white border border-slate-100 font-bold hover:bg-slate-50">取消</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ANALYSIS MODAL -->
  <div id="analysisModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="w-[92vw] max-w-3xl bg-white rounded-3xl shadow-soft border border-slate-100 overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
        <div class="font-extrabold text-lg">今日分析 📊</div>
        <button class="closeAnalysis w-10 h-10 rounded-xl hover:bg-slate-50"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="p-5 grid md:grid-cols-2 gap-5">
        <div class="card p-4">
          <div class="font-bold mb-2">完成度</div>
          <div class="space-y-3">
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-slate-600">热量</span>
                <span class="font-extrabold"><span id="aCalPct">0</span>%</span>
              </div>
              <div class="w-full bg-slate-100 rounded-full h-3">
                <div id="aCalBar" class="bg-orange-400 h-3 rounded-full" style="width:0%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-slate-600">蛋白质</span>
                <span class="font-extrabold"><span id="aProtPct">0</span>%</span>
              </div>
              <div class="w-full bg-slate-100 rounded-full h-3">
                <div id="aProtBar" class="bg-brand-500 h-3 rounded-full" style="width:0%"></div>
              </div>
            </div>

            <div class="p-3 rounded-2xl bg-slate-50 border border-slate-100 text-sm text-slate-600">
              <div class="font-bold text-slate-800">今日摄入</div>
              <div class="mt-1">🔥 <span id="aCalNow">0</span> kcal</div>
              <div>🥩 <span id="aProtNow">0</span> g</div>
              <div class="mt-2 text-xs text-slate-500">提示：如果一天吃不下，尝试把蛋白拆成更多小份（粥+鸡蛋/豆腐/鱼等）。</div>
            </div>
          </div>
        </div>

        <div class="card p-4">
          <div class="font-bold mb-2">宏量营养比例（估算） 🍚🥩🥑</div>
          <p class="text-xs text-slate-500 mb-3">来自你记录的食物（若某食物缺少脂肪/碳水数据，则比例可能偏差）。</p>
          <div class="h-64">
            <canvas id="macroChart"></canvas>
          </div>
          <div class="mt-3 grid grid-cols-3 gap-2 text-center text-sm">
            <div class="p-2 rounded-2xl bg-slate-50 border border-slate-100">
              <div class="text-xs text-slate-500">碳水</div>
              <div class="font-extrabold" id="carbNow">0 g</div>
            </div>
            <div class="p-2 rounded-2xl bg-slate-50 border border-slate-100">
              <div class="text-xs text-slate-500">蛋白</div>
              <div class="font-extrabold" id="protNow">0 g</div>
            </div>
            <div class="p-2 rounded-2xl bg-slate-50 border border-slate-100">
              <div class="text-xs text-slate-500">脂肪</div>
              <div class="font-extrabold" id="fatNow">0 g</div>
            </div>
          </div>
        </div>

        <div class="md:col-span-2 card p-4">
          <div class="flex items-center justify-between">
            <div class="font-bold">今日记录明细 🧾</div>
            <button id="exportDay" class="px-3 py-2 rounded-xl bg-white border border-slate-100 font-semibold hover:bg-slate-50">
              ⬇️ 导出(JSON)
            </button>
          </div>
          <div id="logList" class="mt-3 space-y-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden file input -->
  <input id="importFile" type="file" accept="application/json" class="hidden"/>

  <script src="./app.js"></script>
</body>
</html>
